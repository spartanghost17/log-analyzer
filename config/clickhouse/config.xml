<?xml version="1.0"?>
<clickhouse>
    <!-- ============================================
         SERVER SETTINGS
         Location: /etc/clickhouse-server/config.d/
         These control the ClickHouse server process itself
         ============================================ -->

    <!-- LOGGING CONFIGURATION
         Controls how ClickHouse writes its own operational logs
         (not your application logs - those go into your logs table) -->
    <logger>
        <!-- Log verbosity: trace, debug, information, warning, error -->
        <level>information</level>

        <!-- Where to write general server logs -->
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>

        <!-- Where to write error-only logs -->
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>

        <!-- Max size per log file before rotation (1000 MB) -->
        <size>1000M</size>

        <!-- How many rotated log files to keep -->
        <count>3</count>
    </logger>

    <!-- NETWORK CONFIGURATION
         Controls which network interfaces ClickHouse listens on -->

    <!-- 0.0.0.0 = listen on ALL network interfaces (required for Docker)
         127.0.0.1 = localhost only (more secure, but won't work in Docker)
         :: = all IPv6 interfaces -->
    <listen_host>0.0.0.0</listen_host>

    <!-- CONNECTION LIMITS
         Prevents server overload from too many clients -->

    <!-- Max queries running at the same time
         If exceeded, new queries wait in queue -->
    <max_concurrent_queries>100</max_concurrent_queries>

    <!-- Max simultaneous client connections
         Includes idle connections sitting in connection pools -->
    <max_connections>4096</max_connections>

    <!-- BACKGROUND PROCESSING
         ClickHouse does a lot of work in the background:
         - Merging data parts (MergeTree engines)
         - Mutations (ALTER UPDATE/DELETE)
         - Materialized view updates -->

    <!-- Threads for merge operations and mutations
         Higher = faster merges, but more CPU usage -->
    <background_pool_size>16</background_pool_size>

    <!-- Threads for scheduled tasks (cleanup, TTL, etc.) -->
    <background_schedule_pool_size>16</background_schedule_pool_size>

    <!-- DATA COMPRESSION
         ClickHouse compresses data on disk to save space
         This defines WHEN and HOW to compress -->
    <compression>
        <case>
            <!-- Only compress data parts larger than 10 MB -->
            <min_part_size>10485760</min_part_size>

            <!-- Only compress if part is > 1% of total table size -->
            <min_part_size_ratio>0.01</min_part_size_ratio>

            <!-- Compression algorithm:
                 - lz4: fastest, decent compression (default)
                 - zstd: slower, better compression (recommended)
                 - none: no compression -->
            <method>zstd</method>

            <!-- Compression level (1-22 for zstd)
                 Higher = smaller files, but slower writes -->
            <level>3</level>
        </case>
    </compression>

</clickhouse>